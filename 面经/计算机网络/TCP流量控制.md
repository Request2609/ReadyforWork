# 什么是流量控制

如果发送方把数据发送得过快，接收方可能会来不及接收，这就会造成数据的丢失。所谓**流量控制**就是让发送方的发送速率不要太快，要让接收方来得及接收。流量控制根本目的是防止分组丢失，它是构成TCP可靠性的一方面。

# 如何实现流量控制

利用滑动窗口机制可以很方便地在TCP连接上实现对发送方的流量控制，主要的方式就是接收方返回的 ACK 中会包含自己的接收窗口的大小，并且利用大小来控制发送方的数据发送。

# 流量控制引发的死锁

当发送者收到了一个窗口为零的应答，发送者便停止发送，等待接收者的下一个应答。但是如果下一个窗口不为零的应答在传输过程中丢失，发送者就会一直等待下去，而接收者以为发送者已经收到该应答，也会等待接收新数据，这样双方就相互等待，从而产生死锁。

为了解决这个问题，TCP 为每一个连接设有一个持续计时器（persistence timer）。只要 TCP 连接的一方收到对方的零窗口通知，就启动持续计时器。若持续计时器设置的时间到期，就发送一个零窗口探测报文段（仅携带 1 字节的数据)，而对方就在确认这个探测报文段时给出了现在的窗口值。如果窗口仍然是零，那么收到这个报文段的一方就重新设置持续计时器。如果窗口不是零，那么死锁的僵局就可以打破了。

TCP规定，即使设置为零窗口，也必须接收以下几种报文段：零窗口探测报文段、确认报文段和携带紧急数据的报文。

